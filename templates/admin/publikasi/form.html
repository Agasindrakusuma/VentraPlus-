{% load static %}
<form method="post" enctype="multipart/form-data" class="form" id="beritaForm" action="{% if edit %}{% url 'admin:edit_berita' berita.berita_id %}{% else %}{% url 'admin:tambah_berita' %}{% endif %}">
    {% csrf_token %}
    <div class="d-flex flex-column scroll-y px-5 px-lg-10" data-kt-scroll="true">
        <div class="fv-row mb-7">
            <label class="required fw-semibold fs-6 mb-2">Judul</label>
            <input type="text" value="{{ berita.judul }}" name="frm_judul" class="form-control form-control-solid" placeholder="judul" required />
        </div>

        <div class="fv-row mb-7">
            <label class="required fw-semibold fs-6 mb-2">Images</label>
            <div class="card-body pt-0">
                <div class="image-input image-input-outline" data-kt-image-input="true"
                     {% if berita.images %}style="background-image: url('{{ berita.images.url }}')"{% endif %}>
                    <div class="image-input-wrapper w-150px h-150px"
                         {% if berita.images %}style="background-image: url('{{ berita.images.url }}');"{% endif %}></div>

                    <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                           data-kt-image-input-action="change"
                           data-bs-toggle="tooltip"
                           title="Change cover">
                        <i class="ki-outline ki-pencil fs-7"></i>
                        <input type="file" id="frm_images" name="frm_images" accept=".png, .jpg, .jpeg" />
                    </label>

                    <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                          data-kt-image-input-action="cancel"
                          data-bs-toggle="tooltip"
                          title="Cancel cover">
                        <i class="ki-outline ki-cross fs-2"></i>
                    </span>

                    <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                          data-kt-image-input-action="remove"
                          data-bs-toggle="tooltip"
                          title="Remove cover">
                        <i class="ki-outline ki-cross fs-2"></i>
                    </span>
                </div>
                <div class="text-muted fs-7 mt-2">Format: .png, .jpg, .jpeg</div>
            </div>
        </div>

              

        <div class="fv-row mb-7">
            <label class="required fw-semibold fs-6 mb-2">Deskripsi</label>
            
            <!-- CKEditor Content Container -->
            <div id="kt_docs_ckeditor_document">
                {{ berita.deskripsi_berita|safe }}
            </div>
            
            <!-- Hidden input to store CKEditor content -->
            <input type="hidden" name="frm_deskripsi_berita" id="frm_deskripsi_berita" required>
            
            <div class="text-muted fs-7 mt-2">Tulis Deskripsi di sini.</div>
        </div>


        <div class="mb-10">
            <label class="form-label">Tag</label>
            <input class="form-control" name="tag" id="kt_tagify_1"
                {% if berita %}
                    value='[{% for tag in berita.tag.all %}{"value": "{{ tag.name }}"}{% if not forloop.last %}, {% endif %}{% endfor %}]'
                {% endif %}/>
        </div>
        

        <!-- <div class="mb-10">
            <label class="form-label">Tag</label>
            <input class="form-control" name="tag"  id="kt_tagify_1" {% if data_berita.tag.all %} value="{% for tag in data_berita.tag.all %} {{ tag.name }}, {% endfor %}" {% endif %}/>
        </div> -->

        <div class="fv-row mb-7">
            <label class="required form-label">Kategori</label>
            <select class="form-select form-select-solid" name="kategori_id" data-control="select2" data-placeholder="Pilih Kategori" required>
                <option value="">Pilih Kategori</option>
                {% for data_kategori in dt_kategori %}
                <option value="{{ data_kategori.kategori_id }}"
                    {% if edit and berita.kategori_id and berita.kategori_id.kategori_id == data_kategori.kategori_id %}
                        selected
                    {% endif %}
                >
                    {{ data_kategori.jenis_kategori }}
                </option>
                {% endfor %}
            </select>
        </div>

    
    <!-- Submit -->
    <div class="text-center pt-10">
        <button type="reset" class="btn btn-light me-3" data-bs-dismiss="modal">Batal</button>
        <button type="submit" id="submitBtn" class="btn btn-primary">Simpan</button>
    </div>
</div>
</form>


<link href="{% static 'admin/assets/plugins/global/plugins.bundle.css' %}" rel="stylesheet" type="text/css"/>
<script src="{% static 'admin/assets/plugins/global/plugins.bundle.js' %}"></script>
{% block js %}

<script>
var input1 = document.querySelector("#kt_tagify_1");


// Initialize Tagify components on the above inputs
new Tagify(input1);

</script>
<script>
    
    // Image preview handling
    function handleImagePreview(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const wrapper = input.closest('.image-input').querySelector('.image-input-wrapper');
                wrapper.style.backgroundImage = `url('${e.target.result}')`;
                wrapper.classList.add('image-input-wrapper-loaded');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    document.getElementById('frm_images').addEventListener('change', function() {
        handleImagePreview(this);
    });

    if (typeof KTImageInput !== 'undefined') {
        new KTImageInput(document.querySelector('.image-input'));
    }

    document.querySelector('[data-kt-image-input-action="cancel"]').addEventListener('click', function(e) {
        e.preventDefault();
        const input = document.getElementById('frm_images');
        input.value = '';
        const wrapper = input.closest('.image-input').querySelector('.image-input-wrapper');
        wrapper.style.backgroundImage = '';
        wrapper.classList.remove('image-input-wrapper-loaded');
    });

    document.querySelector('[data-kt-image-input-action="remove"]').addEventListener('click', function(e) {
        e.preventDefault();
        const input = document.getElementById('frm_images');
        input.value = '';
        const wrapper = input.closest('.image-input').querySelector('.image-input-wrapper');
        wrapper.style.backgroundImage = '';
        wrapper.classList.remove('image-input-wrapper-loaded');
    });
</script>

<script>
    // Initialization of Select2 for category dropdown
    $(document).ready(function() {
        $('select[name="kategori_id"]').select2();
    });
</script>

<script>
    // Define a function to initialize the editor after the page has loaded
    function initializeCKEditor() {
        // Check if ClassicEditor is already available (might be loaded from other sources)
        if (typeof ClassicEditor !== 'undefined') {
            createEditor();
        } else {
            // Load CKEditor script
            const script = document.createElement('script');
            script.src = 'https://cdn.ckeditor.com/ckeditor5/38.0.1/classic/ckeditor.js';
            script.onload = createEditor;
            document.head.appendChild(script);
        }
    }

    // Function to create and configure the editor
    function createEditor() {
        ClassicEditor
            .create(document.querySelector('#kt_docs_ckeditor_document'), {
                // Editor configuration
                toolbar: [
                    'heading',
                    '|',
                    'bold', 'italic', 'underline', 'strikethrough',
                    '|',
                    'bulletedList', 'numberedList',
                    '|',
                    'outdent', 'indent',
                    '|',
                    'link', 'blockQuote', 'insertTable', 'imageUpload',
                    '|',
                    'undo', 'redo'
                ],
                heading: {
                    options: [
                        { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                        { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                        { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' }
                    ]
                },
                image: {
                    toolbar: [
                        'imageTextAlternative',
                        'imageStyle:inline',
                        'imageStyle:block',
                        'imageStyle:side'
                    ]
                },
                table: {
                    contentToolbar: [
                        'tableColumn',
                        'tableRow',
                        'mergeTableCells'
                    ]
                }
            })
            .then(editor => {
                // Store editor instance
                window.editor = editor;
                
                // Set initial content if editing
                // {% if edit and berita.deskripsi_berita %}
                // editor.setData(`{{ berita.deskripsi_berita|safe|escapejs }}`);
                // {% endif %}
                
                // Handle form submission - save editor content to hidden input
                document.getElementById('beritaForm').addEventListener('submit', function(event) {
                    // Transfer the editor content to the hidden input field
                    document.getElementById('frm_deskripsi_berita').value = editor.getData();
                    
                    // Check if content is empty
                    if (!document.getElementById('frm_deskripsi_berita').value.trim()) {
                        event.preventDefault();
                        alert('Deskripsi berita tidak boleh kosong');
                        return false;
                    }
                    
                    document.getElementById('submitBtn').disabled = true;
                    document.getElementById('submitBtn').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...';
                });
            })
            .catch(error => {
                console.error('CKEditor initialization failed:', error);
                // Show an error message to the user
                const editorElement = document.querySelector('#kt_docs_ckeditor_document');
                editorElement.innerHTML = '<div class="alert alert-danger">Editor gagal dimuat. Silakan refresh halaman.</div>';
            });
    }

    // Wait for the DOM to be fully loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeCKEditor);
    } else {
        // DOM already loaded, initialize immediately
        initializeCKEditor();
    }

</script>

{% endblock %}