{% extends 'admin/layout/base.html' %}
{% load static %}

{% block main %}
<div class="d-flex flex-column flex-column-fluid">
    <!--begin::Content-->
    <div id="kt_app_content" class="app-content flex-column-fluid">
        <!--begin::Products-->
        <div class="card card-flush">
            <!--begin::Card header-->
            <div class="card-header align-items-center py-5 gap-2 gap-md-5">
                <!--begin::Card title-->
                <div class="d-flex align-items-center position-relative my-1">
                    <i class="ki-outline ki-magnifier fs-3 position-absolute ms-5"></i>
                    <input type="text" 
                        class="form-control form-control-solid w-250px ps-13" 
                        placeholder="Search Ecerpen..." 
                        value="{{ search_query|default:'' }}" id="search-arsip"/>
                </div>
                <div class="card-toolbar">
                    <a href="{% url 'admin:index_e_cerpen' %}" class="btn btn-light-primary me-3">
                        <i class="ki-outline ki-arrow-left fs-2"></i>
                        Kembali ke E-Cerpen
                    </a>
                </div>
            </div>
            <!--end::Card header-->
            
            <!--begin::Card body-->
            <div class="card-body pt-0" id="table-view">
                <!--begin::Table-->
                <table class="table align-middle table-row-dashed fs-6 gy-5" id="table_arsip_ecerpen">
                    <thead>
                        <tr class="text-start text-muted fw-bold fs-7 text-uppercase gs-0">
                            <th class="text-center">No</th>            
                            <th class="text-center">Cover</th>
                            <th class="text-center">Judul</th>
                            <th class="text-center">Penulis</th>
                            <th class="text-center">Tanggal Arsip</th>
                            <th class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 fw-semibold">
                        {% for data_arsip in dt_arsip %}
                        <tr> 
                            <td class="text-center">{{ forloop.counter }}</td>
                            <td class="text-center">
                                {% if data_arsip.cover %}
                                    <img src="{{ data_arsip.cover.url }}" alt="Cover" width="60" class="rounded">
                                {% else %}
                                    <img src="{% static 'admin/assets/media/svg/files/blank-image.svg' %}" width="60" alt="No Image" class="rounded">
                                {% endif %}
                            </td>
                            <td class="text-center">{{ data_arsip.judul }}</td>
                            <td class="text-center">{{ data_arsip.penulis }}</td>
                            <td class="text-center">{{ data_arsip.archived_at|date:"d/m/Y H:i" }}</td>
                            <td class="text-center">
                                <a href="#" class="btn btn-light btn-active-light-primary btn-flex btn-center btn-sm" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
                                    Actions 
                                    <i class="ki-outline ki-down fs-5 ms-1"></i>
                                </a>
                                <!--begin::Menu-->
                                <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4" data-kt-menu="true">
                                    <!--begin::Menu item-->
                                    <div class="menu-item px-3">
                                        <a href="{% url 'admin:detail_e_cerpen' data_arsip.ecerpen_id %}" class="menu-link px-3">
                                            Detail
                                        </a>
                                    </div>
                                    <div class="menu-item px-3">
                                        <a href="{% url 'admin:edit_e_cerpen' data_arsip.ecerpen_id %}" class="menu-link px-3">Edit</a>
                                    </div>
                                    <div class="menu-item px-3">
                                        <form method="post" action="{% url 'admin:restore_e_cerpen' data_arsip.ecerpen_id %}" id="restore-form-{{ data_arsip.ecerpen_id }}">
                                            {% csrf_token %}
                                            <a href="#" class="menu-link px-3" onclick="confirmPulihkan('{{ data_arsip.ecerpen_id }}')">
                                                Pulihkan
                                            </a>
                                        </form>
                                    </div>
                                    <!--end::Menu item-->
                                    
                                    <!--begin::Menu item-->
                                    <div class="menu-item px-3">
                                        <form method="post" action="{% url 'admin:hapus_e_cerpen' data_arsip.ecerpen_id %}" id="delete-form-{{ data_arsip.ecerpen_id }}">
                                            {% csrf_token %}
                                            <a href="#" class="menu-link px-3" onclick="confirmHapus('{{ data_arsip.ecerpen_id }}')">
                                                Hapus
                                            </a>
                                        </form>
                                    </div>
                                    <!--end::Menu item-->
                                </div>
                                <!--end::Menu-->
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <!--end::Table-->
            </div>
            <!--end::Card body-->
        </div>
        <!--end::Products-->
    </div>
    <!--end::Content-->
</div>
{% endblock %}

{% block js %}
<script src="{% static 'admin/assets/js/custom/main-modul.js' %}"></script>

<script>
        function initDataTableArsip() {
        // Destroy DataTable jika sudah ada
        if ($.fn.DataTable.isDataTable('#table_arsip_ecerpen')) {
            $('#table_arsip_ecerpen').DataTable().destroy();
        }

        // Inisialisasi ulang DataTable
        window.table_arsip = new DataTable('#table_arsip_ecerpen');

        // Setup search event listener
        $('#search-arsip').off('keyup').on('keyup', function () {
            window.table_arsip.search(this.value).draw();
        });

        console.log('DataTable diinisialisasi ulang');
    }

    // Inisialisasi saat dokumen siap
    $(document).ready(function () {
        initDataTableArsip();
    });
</script>
<script>
    // let table = new DataTable('#table_arsip_ecerpen');

    // $('#search-arsip').on('keyup', function () {
    //     table.search(this.value).draw();
    // });

    function confirmPulihkan(ecerpen_id) {
        event.preventDefault();
        Swal.fire({
            title: 'Konfirmasi Pemulihan',
            text: 'Apakah Anda yakin ingin memulihkan data ini?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Pulihkan!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('restore-form-' + ecerpen_id).submit();
            }
        });
    }

    function confirmHapus(ecerpen_id) {
        event.preventDefault();
        Swal.fire({
            title: 'Konfirmasi Penghapusan',
            text: 'Apakah Anda yakin ingin menghapus data ini secara permanen?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Hapus!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('delete-form-' + ecerpen_id).submit();
            }
        });
    }
</script>
{% endblock %}