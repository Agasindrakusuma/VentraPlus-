{% extends 'admin/layout/base.html' %}
{% load static %}

{% block main %}
<div class="d-flex flex-column flex-column-fluid">
    <!--begin::Content-->
    <div id="kt_app_content" class="app-content flex-column-fluid">
        <!--begin::Products-->
        <div class="card card-flush">
            <!--begin::Card header-->
            <div class="card-header align-items-center py-5 gap-2 gap-md-5">
                <!--begin::Card title-->
                <div class="card-title">
                    <div class="d-flex align-items-center position-relative my-1">
                        <i class="ki-outline ki-magnifier fs-3 position-absolute ms-5"></i>
                        <input type="text" 
                            class="form-control form-control-solid w-250px ps-13" 
                            placeholder="Search cerpen..." 
                            value="{{ search_query|default:'' }}" id="search"/>
                    </div>
                </div> 
                <!--end::Card title-->
                <!--begin::Card toolbar-->
                <div class="card-toolbar flex-row-fluid justify-content-end gap-5">
                    <!--begin::Add product-->
                    <a href="{% url 'admin:arsip_e_cerpen' %}" class="btn btn-success me-3">
                        <i class="ki-outline ki-inbox fs-2"></i>Data Arsip
                    </a>
                    <a href="{% url 'admin:tambah_e_cerpen' %}" id="tambah-btn" class="btn btn-primary">Tambah E-Cerpen</a>
                    <!--end::Add product-->
                </div>
                <!--end::Card toolbar-->
            </div>
            <!--end::Card header-->
            <!--begin::Card body-->
            <div class="card-body py-4" id="table-view">
                <!--begin::Table-->
                <table class="table align-middle table-row-dashed fs-6 gy-5" id="table_ecerpen">
                    <thead>
                        <tr class="text-center text-gray-500 fw-bold fs-7 text-uppercase gs-0">
                            <th class="text-center">No</th>            
                            <th class="text-center">Cover</th>
                            <th class="text-center">Judul</th>
                            <th class="text-center">Penulis</th>                                
                            <th class="text-center">Status</th>
                            <th class="text-center">Tanggal Publikasi</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 fw-semibold">
                        {% for data_ecerpen in dt_ecerpen %}
                        <tr> 
                            <td class="text-center">{{ forloop.counter }}</td>   
                            <td class="text-center">
                                <div class="symbol symbol-70px symbol-circle">
                                    {% if data_ecerpen.cover %}
                                        <img src="{{ data_ecerpen.cover.url }}" alt="Cover" class="rounded">
                                    {% else %}
                                        <div class="symbol-label bg-light-primary text-primary fs-3 fw-bold">
                                            {{ data_ecerpen.judul|first|upper }}
                                        </div>
                                    {% endif %}
                                </div>
                            </td>                               
                            <td class="text-center">{{ data_ecerpen.judul }}</td>
                            <td class="text-center">{{ data_ecerpen.penulis }}</td>
                            <td class="text-center">
                                {% if data_ecerpen.tanggal_verifikasi %}
                                <div>
                                    <span class="badge badge-light-success">Terverifikasi</span>
                                    <div class="text-muted fs-8 mt-1">
                                        {{ data_ecerpen.tanggal_verifikasi|date:"d M Y H:i" }}
                                    </div>
                                </div>
                                {% elif data_ecerpen.status == "ditolak" %}
                                    <span class="badge badge-light-danger">Ditolak</span>
                                {% elif data_ecerpen.status == "revisi" %}
                                    <span class="badge badge-light-info">Revisi</span>
                                {% else %}
                                    <span class="badge badge-light-warning">Menunggu</span>
                                {% endif %}
                            </td>                            
                            
                            <td class="text-center">{{ data_ecerpen.tanggal_publikasi|date:"d/m/Y" }}</td>
                            <td class="text-center">
                                <a href="#" class="btn btn-sm btn-light btn-flex btn-center btn-active-light-primary" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">Actions 
                                    <i class="ki-outline ki-down fs-5 ms-1"></i>
                                </a>
                                <!--begin::Menu-->
                                <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4" data-kt-menu="true">
                                    <!--begin::Menu item-->
                                    <div class="menu-item px-3">
                                        <a href="{% url 'admin:detail_e_cerpen' data_ecerpen.ecerpen_id %}" class="menu-link px-3">Detail</a>
                                    </div>
                                    <div class="menu-item px-3">
                                        <a href="{% url 'admin:edit_e_cerpen' data_ecerpen.ecerpen_id %}" class="menu-link px-3">Edit</a>
                                    </div>
                                    <div class="menu-item px-3">
                                        <form method="post" action="{% url 'admin:archive_e_cerpen' data_ecerpen.ecerpen_id %}" id="archive-form-{{ data_ecerpen.ecerpen_id }}">
                                            {% csrf_token %}
                                            <a href="#" class="menu-link px-3" onclick="confirmArchive('{{ data_ecerpen.ecerpen_id }}')">
                                                Arsipkan
                                            </a>
                                        </form>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <!--end::Table-->
            </div>
            <!--end::Card body-->
        </div>
        <!--end::Products-->
    </div>
    <!--end::Content-->
</div>
{% endblock %}

{% block js %}

<script src="{% static 'admin/assets/js/custom/main-modul.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- <script>
    let table = new DataTable('#table_ecerpen');


    $('#search').on('keyup', function () {
        table.search(this.value).draw();
    });
</script> -->


<script>
$.fn.dataTable.ext.order['row-number'] = function (settings, col) {
return this.api().column(col, {order:'index'}).nodes().map(function (td, i) {
    return i + 1;
});
};


function initMainDataTable() {
if ($.fn.DataTable.isDataTable('#table_ecerpen')) {
    $('#table_ecerpen').DataTable().destroy();
}

// Inisialisasi DataTable
window.table = $('#table_ecerpen').DataTable({
    columnDefs: [
        {
            targets: 0,
            orderable: true,  // Mengaktifkan pengurutan untuk kolom nomor
            searchable: false,
            className: 'text-center',
            render: function (data, type, full, meta) {
                if (type === 'display' || type === 'filter') {
                    return meta.row + 1;
                }
                // Untuk pengurutan, gunakan indeks asli
                return meta.row;
            },
            // Menggunakan pengurutan khusus
            orderDataType: 'row-number'
        }
    ],
    
    // Menerapkan pengurutan default pada kolom "No" secara ascending
    order: [[0, 'asc']]
});

// Setup search event listener
$('#search').off('keyup').on('keyup', function () {
    window.table.search(this.value).draw();
});
}

// Inisialisasi ketika dokumen siap
$(document).ready(function () {
// Inisialisasi DataTable utama
initMainDataTable();


});
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Inisialisasi elemen-elemen penting
        const inputElement = document.getElementById("dt-search-0");
        const savedQuery = searchParams.get("search") || localStorage.getItem("searchQuery");

        if (savedQuery && inputElement) {
            inputElement.value = savedQuery;
        }

        // Perbarui pagination links agar menyertakan parameter pencarian
        document.querySelectorAll(".pagination a.page-link").forEach(link => {
            const url = new URL(link.href);
            const page = url.searchParams.get("page");
            if (page) {
                const newParams = new URLSearchParams(searchParams.toString());
                newParams.set("page", page);
                link.href = `${window.location.pathname}?${newParams.toString()}`;
            }
        });

        // Event listener untuk input pencarian
        if (inputElement) {
            let typingTimer;
            const doneTypingInterval = 1000;

            inputElement.addEventListener("input", () => {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    const query = inputElement.value.trim();
                    updateUrl("search", query);
                    localStorage.setItem("searchQuery", query);
                }, doneTypingInterval);
            });
        }
    });

    // Fungsi untuk toggle tampilan antara data dan arsip
    function showTable() {
        toggleView(true);
    }

    function showArsip() {
        toggleView(false);
    }

    function toggleView(isTable) {
        document.getElementById('table-view').classList.toggle('d-none', !isTable);
        document.getElementById('arsip-view').classList.toggle('d-none', isTable);
        document.getElementById('arsip-btn').classList.toggle('d-none', !isTable);
        document.getElementById('tambah-btn').classList.toggle('d-none', !isTable);
        document.getElementById('back-btn').classList.toggle('d-none', isTable);
    }

    // Konfirmasi arsip dengan SweetAlert
    function confirmArchive(profileId) {
        Swal.fire({
            title: 'Konfirmasi Arsip',
            text: 'Apakah Anda yakin ingin mengarsipkan data ini?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Arsipkan!',
            cancelButtonText: 'Batal'
        }).then(result => {
            if (result.isConfirmed) {
                document.getElementById('archive-form-' + profileId).submit();
            }
        });
    }

    // Fungsi untuk memuat modal dari URL
    function showModal(url, options = {}) {
        fetch(url)
            .then(response => response.text())
            .then(html => {
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = html;
                document.body.appendChild(modalContainer);

                const modalElement = modalContainer.querySelector('.modal');
                const bsModal = new bootstrap.Modal(modalElement);
                bsModal.show();

                modalElement.addEventListener('hidden.bs.modal', () => {
                    modalContainer.remove();
                });
            })
            .catch(error => {
                console.error('Gagal memuat modal:', error);
            });
    }

    // Modal arsip dari atribut data-alt
    function ModalArsip(el) {
        const url = el.getAttribute("data-alt");
        if (url) {
            showModal(url);
        }
    }

    // Tampilkan preview PDF dari HTML
    function showPdfPreview(title, content) {
        document.getElementById('pdfPreviewTitle').textContent = 'Preview: ' + title;

        const pdfContent = document.getElementById('pdfContent');
        pdfContent.innerHTML = '';

        const pdfContainer = document.createElement('div');
        Object.assign(pdfContainer.style, {
            fontFamily: 'Arial, sans-serif',
            lineHeight: '1.6',
            padding: '20px',
            maxWidth: '800px',
            margin: '0 auto',
            background: 'white',
            boxShadow: '0 0 10px rgba(0,0,0,0.1)'
        });
        pdfContainer.innerHTML = content;

        pdfContent.appendChild(pdfContainer);

        const modal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
        modal.show();
    }

    // Cetak isi PDF yang ditampilkan
    function printPdfContent() {
        const printContent = document.getElementById('pdfContent').innerHTML;
        const originalContent = document.body.innerHTML;

        document.body.innerHTML = printContent;
        window.print();
        document.body.innerHTML = originalContent;

        // Reload halaman untuk mengembalikan event listener
        window.location.reload();
    }

    // Fungsi pembaruan parameter URL
    let searchParams = new URLSearchParams(window.location.search);

    function updateUrl(parameterName, parameterValue) {
        searchParams.delete(parameterName);
        if (parameterValue) {
            searchParams.append(parameterName, parameterValue);
        }
        window.location.href = window.location.pathname + "?" + searchParams.toString();
    }
</script>

{% endblock %}