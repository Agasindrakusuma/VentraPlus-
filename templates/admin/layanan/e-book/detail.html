{% extends 'admin/layout/base.html' %}
{% load static %}

{% block main %}
<div class="d-flex flex-column flex-column-fluid">
    <!--begin::Content-->
    <div id="kt_app_content" class="app-content flex-column-fluid">
        <!--begin::Detail View-->
        <div class="card">
            <!--begin::Card header-->
            <div class="card-header border-0 pt-6">
                <div class="card-title">
                    <h2>Detail E-Book</h2>
                </div>
            </div>
            <!--end::Card header-->
            
            <!--begin::Card body-->
            <div class="card-body pt-0">
                <div class="d-flex flex-column flex-xl-row">
                    <!--begin::Cover & Info-->
                    <div class="flex-column flex-lg-row-auto w-100 w-xl-300px mb-10">
                        <!--begin::Cover-->
                        <div class="card mb-5 mb-xl-8">
                            <div class="card-body text-center">
                                {% if ebook.cover %}
                                    <img src="{{ ebook.cover.url }}" alt="Cover" class="img-fluid rounded" style="max-height: 300px;">
                                {% else %}
                                    <div class="symbol symbol-200px symbol-circle bg-light-primary text-primary fs-1 fw-bold">
                                        {{ ebook.judul|first|upper }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <!--end::Cover-->
                        
                        <!--begin::Basic Info-->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Informasi Dasar</h3>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td class="fw-bold text-gray-600">Judul</td>
                                            <td>{{ ebook.judul }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold text-gray-600">Penulis</td>
                                            <td>{{ ebook.penulis }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold text-gray-600">Bahasa</td>
                                            <td>{{ ebook.bahasa }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold text-gray-600">Durasi Baca</td>
                                            <td>{{ ebook.durasi_baca }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold text-gray-600">Status</td>
                                            <td>
                                                {% if ebook.tanggal_verifikasi %}
                                                    <span class="badge badge-light-success">Terverifikasi</span>
                                                {% elif ebook.status == "ditolak" %}
                                                    <span class="badge badge-light-danger">Ditolak</span>
                                                {% elif ebook.status == "revisi" %}
                                                    <span class="badge badge-light-info">Revisi</span>
                                                {% else %}
                                                    <span class="badge badge-light-warning">Menunggu</span>
                                                {% endif %}
                                            </td>
                                            
                                        </tr>
                                        {% if ebook.status == "ditolak" or ebook.status == "revisi" %}
                                        <tr>
                                            <td class="fw-bold text-gray-600">Alasan Penolakan</td>
                                            <td style="max-width: 150px;">{{ ebook.alasan_penolakan }}</td>
                                        </tr>
                                        {% endif %}
                                        <tr>
                                            <td class="fw-bold text-gray-600">Nama Creator</td>
                                            <td>
                                                <span class="badge badge-light-primary">
                                                    {{ ebook.creator.nama_creator|default:"-" }}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold text-gray-600">Untuk Usia</td>
                                            <td>{{ ebook.batas_usia }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold text-gray-600">Tanggal tahun terbit</td>
                                            <td>{{ ebook.tahun_terbit |date:"d/M/Y " }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold text-gray-600">Tanggal Publikasi</td>
                                            <td>{{ ebook.tanggal_publikasi|date:"d/M/Y " }}</td>
                                        </tr>
                                        {% if ebook.tanggal_verifikasi %}
                                        <tr>
                                            <td class="fw-bold text-gray-600">Tanggal Verifikasi</td>
                                            <td>{{ ebook.tanggal_verifikasi|date:"d/M/Y H:i " }}</td>
                                        </tr>
                                        {% endif %}
                                        <tr>
                                            <td class="fw-bold text-gray-600">Kategori</td>
                                            <td>{{ ebook.kategori_id.nama_kategori|default:"-" }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!--end::Basic Info-->
                    </div>
                    <!--end::Cover & Info-->
                    
                    <!--begin::Content-->
                    <div class="flex-lg-row-fluid ms-lg-10">
                        <!--begin::Sinopsis-->
                        <div class="card mb-5 mb-xl-8">
                            <div class="card-header">
                                <h3 class="card-title">Sinopsis</h3>
                            </div>
                            <div class="card-body">
                                <div class="fs-5 lh-2">{{ ebook.sinopsis_ebook|safe }}</div>                            </div>
                        </div>
                        
                        <!--end::Sinopsis-->
                        
                        <!--begin::Isi book-->
                        <div class="card mb-5 mb-xl-8">
                            <div class="card-header">
                                <div class="card-title">
                                    <h3>Isi E-Book</h3>
                                </div>
                                <div class="card-toolbar">
                                    {% if ebook.path_ebook %}
                                        <a href="{{ ebook.path_ebook.url }}" class="btn btn-sm btn-light-primary" download>
                                            <i class="ki-outline ki-download fs-2"></i> Unduh
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-body">
                                {% if ebook.path_ebook %}
                                    <div class="d-flex flex-column h-100">
                                        <!-- Area preview PDF -->
                                        <div class="border rounded position-relative" style="height: 600px; overflow: auto;">
                                            {% if ebook.path_ebook.name|lower|slice:'-4:' == '.pdf' %}
                                                <!-- Menggunakan PDF.js dengan render progresif -->
                                                <div id="pdf-viewer-container" style="min-height: 100%;">
                                                    <!-- Canvas akan ditambahkan secara dinamis per halaman -->
                                                </div>
                                                
                                                <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
                                                <script>
                                                    // Inisialisasi PDF.js
                                                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
                                                    
                                                    // Variabel global
                                                    let currentPage = 1;
                                                    let pdfDoc = null;
                                                    let scale = 1.5;
                                                    
                                                    // Fungsi untuk render halaman PDF
                                                    function renderPage(pageNum) {
                                                        pdfDoc.getPage(pageNum).then(function(page) {
                                                            const container = document.getElementById('pdf-viewer-container');
                                                            const viewport = page.getViewport({scale: scale});
                                                            
                                                            // Buat canvas baru untuk halaman ini
                                                            const canvas = document.createElement('canvas');
                                                            const ctx = canvas.getContext('2d');
                                                            canvas.height = viewport.height;
                                                            canvas.width = viewport.width;
                                                            canvas.style.marginBottom = '20px';
                                                            canvas.style.display = 'block';
                                                            
                                                            // Tambahkan canvas ke container
                                                            container.appendChild(canvas);
                                                            
                                                            // Render halaman
                                                            page.render({
                                                                canvasContext: ctx,
                                                                viewport: viewport
                                                            });
                                                            
                                                            // Jika masih ada halaman berikutnya, render
                                                            if (pageNum < pdfDoc.numPages) {
                                                                currentPage++;
                                                                renderPage(currentPage);
                                                            }
                                                        });
                                                    }
                                                    
                                                    // Fungsi untuk memuat PDF
                                                    function loadPDF(url) {
                                                        const container = document.getElementById('pdf-viewer-container');
                                                        
                                                        // Tampilkan loading indicator
                                                        container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-3">Memuat dokumen...</p></div>';
                                                        
                                                        pdfjsLib.getDocument(url).promise
                                                            .then(function(pdf) {
                                                                pdfDoc = pdf;
                                                                container.innerHTML = ''; // Kosongkan container
                                                                renderPage(1); // Mulai render dari halaman 1
                                                            })
                                                            .catch(function(error) {
                                                                container.innerHTML = `
                                                                    <div class="alert alert-danger m-3">
                                                                        <p>Gagal memuat PDF. Silakan unduh file untuk melihat isinya.</p>
                                                                        <a href="${url}" class="btn btn-danger" download>
                                                                            <i class="ki-outline ki-download fs-2"></i> Unduh PDF
                                                                        </a>
                                                                    </div>
                                                                `;
                                                                console.error('PDF.js error:', error);
                                                            });
                                                    }
                                                    
                                                    // Jalankan fungsi loadPDF
                                                    loadPDF("{{ ebook.path_ebook.url }}");
                                                    
                                                    // Optimasi scroll dengan Intersection Observer
                                                    const observer = new IntersectionObserver((entries) => {
                                                        entries.forEach(entry => {
                                                            if (entry.isIntersecting) {
                                                                // Lazy load bisa ditambahkan di sini jika diperlukan
                                                            }
                                                        });
                                                    }, {threshold: 0.1});
                                                    
                                                    // Terapkan observer setelah PDF selesai di-load
                                                </script>
                                            {% else %}
                                                <!-- Untuk format non-PDF -->
                                                <div class="alert alert-info m-4">
                                                    <p>Format file tidak mendukung preview. Silakan unduh untuk melihat isinya.</p>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% else %}
                                    <!-- Jika tidak ada file -->
                                    <div class="alert alert-warning">
                                        Tidak ada dokumen yang diunggah
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <!--end::Isi book-->
                        
                        <!--begin::Actions-->
                        <div class="card">
                            <div class="card-footer d-flex justify-content-between">
                                <div class="card-toolbar">
                                    <a href="{% url 'admin:index_e_book' %}" class="btn btn-light-primary">
                                        <i class="ki-outline ki-arrow-left fs-2"></i> Kembali
                                    </a>
                                </div>
                        
                                <div class="card-toolbar">
                                    {% if ebook.status == "ditolak" %}
                                        <a href="#" class="btn btn-warning me-3 batal-tolak-btn" data-id="{{ ebook.ebook_id }}">
                                            <i class="ki-outline ki-arrow-left fs-2"></i> Batalkan Penolakan
                                        </a>
                                    {% elif ebook.status == "terverifikasi" %}
                                        <a href="#" class="btn btn-warning me-3 batal-verifikasi-btn" data-id="{{ ebook.ebook_id }}">
                                            <i class="ki-outline ki-arrow-left fs-2"></i> Batalkan Verifikasi
                                        </a>
                                    {% else %}
                                        <a href="#" class="btn btn-danger me-3 tolak-btn" data-id="{{ ebook.ebook_id }}">
                                            <i class="ki-outline ki-cross fs-2"></i> Ditolak
                                        </a>                                    
                                        <a href="#" class="btn btn-success verifikasi-btn" data-id="{{ ebook.ebook_id }}">
                                            <i class="ki-outline ki-shield-tick fs-2"></i> Verifikasi
                                        </a>
                                    {% endif %}
                                </div>
                                
                                
                            </div>
                        </div>
                        <!--end::Actions-->
                    </div>
                    <!--end::Content-->
                </div>
            </div>
            <!--end::Card body-->
        </div>
        <!--end::Detail View-->
    </div>
    <!--end::Content-->
</div>
{% endblock %}

{% block js %}
<!-- button tolak -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tolakBtn = document.querySelector('.tolak-btn');
    
        tolakBtn.addEventListener('click', function (e) {
            e.preventDefault();
            const bookId = this.getAttribute('data-id');
    
            Swal.fire({
                icon: 'question',
                title: 'Yakin Ebook Ini di Tolak?',
                input: 'textarea',
                inputPlaceholder: 'Tuliskan alasan mengapa Ebook ini ditolak...',
                inputAttributes: {
                    'aria-label': 'Alasan Penolakan'
                },
                showCancelButton: true,
                confirmButtonText: 'Tolak',
                cancelButtonText: 'Batal',
                preConfirm: (alasan) => {
                    if (!alasan) {
                        Swal.showValidationMessage('Alasan tidak boleh kosong');
                    }
                    return alasan;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch("{% url 'admin:tolak_e_book' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({
                            id: bookId,
                            alasan: result.value
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        Swal.fire('Ditolak!', data.message, 'success')
                            .then(() => location.reload());
                    })
                    .catch(() => {
                        Swal.fire('Gagal', 'Terjadi kesalahan saat menolak book.', 'error');
                    });
                }
            });
        });
    });
</script>
    
<!-- button verifikasi -->
<script>
        document.addEventListener('DOMContentLoaded', function () {
            const verifButtons = document.querySelectorAll('.verifikasi-btn');
        
            verifButtons.forEach(function (btn) {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const bookId = btn.getAttribute('data-id');
        
                    Swal.fire({
                        title: 'Verifikasi book?',
                        text: "Anda yakin ingin memverifikasi Ebook ini?",
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Ya, Verifikasi!',
                        cancelButtonText: 'Batal'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            fetch("{% url 'admin:verifikasi_e_book' %}", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": "{{ csrf_token }}"
                                },
                                body: JSON.stringify({ id: bookId })
                            })
                            .then(res => {
                                if (!res.ok) throw new Error("Gagal verifikasi book");
                                return res.json();
                            })
                            .then(data => {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Berhasil!',
                                    text: data.message || 'Ebook berhasil diverifikasi.'
                                }).then(() => location.reload());
                            })
                            .catch(err => {
                                console.error(err);
                                Swal.fire('Gagal', 'Terjadi kesalahan saat verifikasi.', 'error');
                            });
                        }
                    });
                });
            });
        });
</script>

<!-- batalkan penolakan dan verifikasi -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Batalkan Penolakan
    const batalTolakBtn = document.querySelector('.batal-tolak-btn');
    if (batalTolakBtn) {
        batalTolakBtn.addEventListener('click', function (e) {
            e.preventDefault();
            const bookId = this.getAttribute('data-id');

            Swal.fire({
                title: 'Batalkan penolakan Ebook?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, Batalkan',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch("{% url 'admin:batal_tolak_e_book' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({ id: bookId })
                    })
                    .then(res => {
                        if (!res.ok) throw new Error("Gagal batalkan penolakan");
                        return res.json();
                    })
                    .then(data => {
                        Swal.fire('Berhasil', data.message, 'success')
                            .then(() => location.reload());
                    })
                    .catch(() => {
                        Swal.fire('Gagal', 'Terjadi kesalahan saat membatalkan penolakan.', 'error');
                    });
                }
            });
        });
    }

    // Batalkan Verifikasi
    const batalVerifBtn = document.querySelector('.batal-verifikasi-btn');
    if (batalVerifBtn) {
        batalVerifBtn.addEventListener('click', function (e) {
            e.preventDefault();
            const bookId = this.getAttribute('data-id');

            Swal.fire({
                title: 'Batalkan verifikasi Ebook?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, Batalkan',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch("{% url 'admin:batal_verifikasi_e_book' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({ id: bookId })
                    })
                    .then(res => {
                        if (!res.ok) throw new Error("Gagal batalkan verifikasi");
                        return res.json();
                    })
                    .then(data => {
                        Swal.fire('Berhasil', data.message, 'success')
                            .then(() => location.reload());
                    })
                    .catch(() => {
                        Swal.fire('Gagal', 'Terjadi kesalahan saat membatalkan verifikasi.', 'error');
                    });
                }
            });
        });
    }
});

</script>
    
{% endblock %}