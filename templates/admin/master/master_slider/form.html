<form method="post" enctype="multipart/form-data" class="form" id="sliderForm" 
      action="{% if edit %}{% url 'admin:edit_master_slider' slider.slider_id %}{% else %}{% url 'admin:tambah_master_slider' %}{% endif %}">
    {% csrf_token %}
    
    <div class="d-flex flex-column scroll-y px-5 px-lg-10" data-kt-scroll="true">
        <!-- Judul Slider -->
        <div class="fv-row mb-7">
            <label class="required fw-semibold fs-6 mb-2">Judul Slider</label>
            <input type="text" name="frm_judul_slider" class="form-control form-control-solid" 
                   placeholder="Judul Slider" 
                   value="{% if edit %}{{ slider.judul_slider }}{% endif %}" required />
        </div>

        <!-- Sub Judul Slider -->
        <div class="fv-row mb-7">
            <label class="required fw-semibold fs-6 mb-2">Sub Judul Slider</label>
            <input type="text" name="frm_sub_judul_slider" class="form-control form-control-solid" 
                   placeholder="Sub Judul Slider" 
                   value="{% if edit %}{{ slider.sub_judul_slider }}{% endif %}" required />
        </div>

        <!-- Tampilan Judul -->
        <div class="fv-row mb-7">
            <label class="required fw-semibold fs-6 mb-2">Tampilan Judul</label>
            <input type="text" name="frm_tampilan_judul" class="form-control form-control-solid" 
                   placeholder="Tampilan Judul" 
                   value="{% if edit %}{{ slider.tampilan_judul }}{% endif %}" required />
        </div>

        <!-- Background Slider -->
        <div class="row mb-7">  <!-- Baris utama -->
            <!-- Kolom background_slider -->
            <div class="col-md-6 fv-row">
                <label class="required fw-semibold fs-6 mb-2">Background Slider</label>
                <div class="card-body pt-0">
                    <!-- Radio button untuk pilihan tipe background -->
                    <div class="mb-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="background_type" id="background_image" value="image" 
                                   {% if not edit or not slider.is_video_background %}checked{% endif %}>
                            <label class="form-check-label" for="background_image">Gambar</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="background_type" id="background_video" value="video"
                                   {% if edit and slider.is_video_background %}checked{% endif %}>
                            <label class="form-check-label" for="background_video">Video</label>
                        </div>
                    </div>
                    
                    <!-- Container untuk gambar -->
                    <div id="image_container" class="{% if edit and slider.is_video_background %}d-none{% endif %}">
                        <div class="image-input image-input-outline" data-kt-image-input="true"
                             {% if edit and slider.background_slider and not slider.is_video_background %}style="background-image: url('{{ slider.background_slider.url }}')"{% endif %}>
                            <div class="image-input-wrapper w-150px h-150px"
                                 {% if edit and slider.background_slider and not slider.is_video_background %}style="background-image: url('{{ slider.background_slider.url }}');"{% endif %}></div>
            
                            <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                                   data-kt-image-input-action="change"
                                   data-bs-toggle="tooltip"
                                   title="Change cover">
                                <i class="ki-outline ki-pencil fs-7"></i>
                                <input type="file" id="frm_background_slider" name="frm_background_slider" accept=".png, .jpg, .jpeg" />
                            </label>
            
                            <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                                  data-kt-image-input-action="cancel"
                                  data-bs-toggle="tooltip"
                                  title="Cancel cover">
                                <i class="ki-outline ki-cross fs-2"></i>
                            </span>
            
                            <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                                  data-kt-image-input-action="remove"
                                  data-bs-toggle="tooltip"
                                  title="Remove cover">
                                <i class="ki-outline ki-cross fs-2"></i>
                            </span>
                        </div>
                        <div class="text-muted fs-7 mt-2">Format: .png, .jpg, .jpeg</div>
                    </div>
                    
                    <!-- Container untuk video -->
                    <div id="video_container" class="{% if not edit or not slider.is_video_background %}d-none{% endif %}">
                        <div class="video-input-wrapper position-relative" style="width: 150px; height: 150px; overflow: hidden; border-radius: 0.475rem;">
                            {% if edit and slider.background_slider and slider.is_video_background %}
                            <video id="video_preview" style="width: 100%; height: 100%; object-fit: cover;" controls>
                                <source src="{{ slider.background_slider.url }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            {% else %}
                            <video id="video_preview" style="width: 100%; height: 100%; object-fit: cover; display: none;" controls>
                                <source src="" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div id="video_placeholder" class="d-flex justify-content-center align-items-center bg-light" style="width: 100%; height: 100%;">
                                <i class="ki-outline ki-video fs-2x text-muted"></i>
                            </div>
                            {% endif %}
                            
                            <div class="position-absolute top-0 end-0 mt-2 me-2">
                                <label class="btn btn-icon btn-circle btn-sm btn-active-color-primary w-25px h-25px bg-body shadow"
                                       for="frm_background_video">
                                    <i class="ki-outline ki-pencil fs-7"></i>
                                </label>
                                <input type="file" id="frm_background_video" name="frm_background_video" accept=".mp4, .webm, .ogg" style="display: none;" />
                                
                                <span class="btn btn-icon btn-circle btn-sm btn-active-color-primary w-25px h-25px bg-body shadow ms-2"
                                      id="remove_video">
                                    <i class="ki-outline ki-cross fs-7"></i>
                                </span>
                            </div>
                        </div>
                        <div class="text-muted fs-7 mt-2">Format: .mp4, .webm, .ogg</div>
                        <!-- Hidden field to track if it's a video -->
                        <input type="hidden" name="is_video_background" id="is_video_background" value="{% if edit and slider.is_video_background %}true{% else %}false{% endif %}" />
                    </div>
                </div>
            </div>
        
            <!-- Kolom elemen_gambar -->
            <div class="col-md-6 fv-row">
                <label class="required fw-semibold fs-6 mb-2">Elemen Gambar</label>
                <div class="card-body pt-0">
                    <div class="image-input image-input-outline" data-kt-image-input="true"
                         {% if slider.elemen_gambar %}style="background-image: url('{{ slider.elemen_gambar.url }}')"{% endif %}>
                        <div class="image-input-wrapper w-150px h-150px"
                             {% if slider.elemen_gambar %}style="background-image: url('{{ slider.elemen_gambar.url }}');"{% endif %}></div>
        
                        <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                               data-kt-image-input-action="change"
                               data-bs-toggle="tooltip"
                               title="Change cover">
                            <i class="ki-outline ki-pencil fs-7"></i>
                            <input type="file" id="frm_elemen_gambar" name="frm_elemen_gambar" accept=".png, .jpg, .jpeg" />
                        </label>
        
                        <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                              data-kt-image-input-action="cancel"
                              data-bs-toggle="tooltip"
                              title="Cancel cover">
                            <i class="ki-outline ki-cross fs-2"></i>
                        </span>
        
                        <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                              data-kt-image-input-action="remove"
                              data-bs-toggle="tooltip"
                              title="Remove cover">
                            <i class="ki-outline ki-cross fs-2"></i>
                        </span>
                    </div>
                    <div class="text-muted fs-7 mt-2">Format: .png, .jpg, .jpeg</div>
                </div>
            </div>
        </div>

        <!-- Link -->
        <div class="fv-row mb-7">
            <label class="required fw-semibold fs-6 mb-2">Link</label>
            <input type="text" name="frm_link" class="form-control form-control-solid" 
                   placeholder="Link" 
                   value="{% if edit %}{{ slider.link }}{% endif %}" required />
        </div>

        <div class="text-center pt-10">
            <button type="reset" class="btn btn-light me-3" data-bs-dismiss="modal">Batal</button>
            <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
    </div>
</form>

<!-- Script untuk preview gambar dan video -->
<script>
    // Fungsi untuk menangani preview gambar
    function handleImagePreview(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const wrapper = input.closest('.image-input').querySelector('.image-input-wrapper');
                wrapper.style.backgroundImage = `url('${e.target.result}')`;
                wrapper.classList.add('image-input-wrapper-loaded');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Fungsi untuk menangani preview video
    function handleVideoPreview(input) {
        const videoPreview = document.getElementById('video_preview');
        const videoPlaceholder = document.getElementById('video_placeholder');
        
        if (input.files && input.files[0]) {
            const videoURL = URL.createObjectURL(input.files[0]);
            videoPreview.src = videoURL;
            videoPreview.style.display = 'block';
            if (videoPlaceholder) {
                videoPlaceholder.style.display = 'none';
            }
        }
    }

    // Mengganti antara input gambar dan video
    document.querySelectorAll('input[name="background_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const imageContainer = document.getElementById('image_container');
            const videoContainer = document.getElementById('video_container');
            const isVideoField = document.getElementById('is_video_background');
            
            if (this.value === 'image') {
                imageContainer.classList.remove('d-none');
                videoContainer.classList.add('d-none');
                isVideoField.value = 'false';
            } else {
                imageContainer.classList.add('d-none');
                videoContainer.classList.remove('d-none');
                isVideoField.value = 'true';
            }
        });
    });

    // Event listener untuk perubahan gambar
    document.getElementById('frm_background_slider')?.addEventListener('change', function() {
        handleImagePreview(this);
    });
    
    document.getElementById('frm_elemen_gambar')?.addEventListener('change', function() {
        handleImagePreview(this);
    });

    // Event listener untuk perubahan video
    document.getElementById('frm_background_video')?.addEventListener('change', function() {
        handleVideoPreview(this);
    });

    // Event listener untuk hapus video
    document.getElementById('remove_video')?.addEventListener('click', function() {
        const videoPreview = document.getElementById('video_preview');
        const videoPlaceholder = document.getElementById('video_placeholder');
        const videoInput = document.getElementById('frm_background_video');
        
        videoPreview.src = '';
        videoPreview.style.display = 'none';
        if (videoPlaceholder) {
            videoPlaceholder.style.display = 'flex';
        }
        
        // Reset input file
        videoInput.value = '';
    });

    // Inisialisasi KTImageInput jika tersedia
    if (typeof KTImageInput !== 'undefined') {
        document.querySelectorAll('.image-input').forEach(element => {
            new KTImageInput(element);
        });
    }
</script>

<style>
    .image-input-wrapper {
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 0.475rem;
    }
    .image-input-wrapper-loaded {
        border: 3px solid #009ef7;
    }
    .video-input-wrapper {
        border: 1px solid #e4e6ef;
    }
    .video-input-wrapper video:not(:empty) + #video_placeholder {
        display: none;
    }
</style>