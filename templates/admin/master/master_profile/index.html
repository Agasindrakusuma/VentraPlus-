{% extends 'admin/layout/base.html' %}

{% load static %}

{% block main %}

<div class="app-main flex-column flex-row-fluid" id="kt_app_main">
    <div class="d-flex flex-column flex-column-fluid">
        <div id="kt_app_content" class="app-content flex-column-fluid">
            <div class="card">
                <div class="card-header border-0 pt-6">
                    <div class="card-title">
                        <div class="d-flex align-items-center position-relative my-1">
                            <i class="ki-outline ki-magnifier fs-3 position-absolute ms-5"></i>
                            <input type="text" 
                                   class="form-control form-control-solid w-250px ps-13" 
                                   placeholder="Search profile..." 
                                   value="{{ search_query|default:'' }}" id="search"/>
                        </div>
                    </div>  
                    <div class="card-toolbar">
                        <div class="d-flex justify-content-end" data-kt-user-table-toolbar="base">
                            <a data-alt="{% url 'admin:arsip_master_profile' %}" data-modal-title="Data Arsip Profile" onclick="ModalArsip(this)"  class="btn btn-success me-3">
                                <i class="ki-outline ki-inbox fs-2"></i>Data Arsip
                            </a>

                            <!--end::Button arsip-->
                            <button type="button" id="tambah-btn" class="btn btn-primary" data-alt="{% url 'admin:tambah_master_profile' %}" data-modal-title="Tambah Profile" onclick="ModalTambah(this)">
                                <i class="ki-outline ki-plus fs-2"></i>Tambah Data
                            </button>
                            <!--end::Button tambah-->
                        </div>
                    </div>
                    <!--end::Card toolbar-->
                </div>
                <!--end::Card header-->
                
                <div class="card-body py-4" id="table-view">
                    <table class="table align-middle table-row-dashed fs-6 gy-5" id="table_profile">
                        <thead>
                            <tr class="text-start text-muted fw-bold fs-7 text-uppercase gs-0">
                                <th class="min-w-50px">No</th>
                                <th class="min-w-125px">Images</th>
                                <th class="min-w-125px">Tipe</th>
                                <th class="min-w-125px">Deskripsi</th>
                                <th class="text-end min-w-100px">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 fw-semibold">
                            {% for data_profile in dt_profile %}
                            <tr>
                                <td >{{ forloop.counter }}</td>  
                                <td >
                                    <div class="symbol symbol-70px symbol-circle">
                                    {% if data_profile.images %}
                                        <img src="{{ data_profile.images.url }}" alt="images" class="rounded">
                                    {% else %}
                                    <div class="symbol-label bg-light-primary text-primary fs-3 fw-bold">
                                        <img src="{% static 'admin/assets/media/svg/files/blank-image.svg' %}" width="100" alt="No Image">
                                    {% endif %}
                                </td> 
                                <td>
                                    <span class="badge badge-light-primary">
                                        {{ data_profile.get_tipe_display }}
                                    </span>
                                </td>
<!-- Di template index.html -->
                                <td>
                                    <button onclick="showPdfPreview('{{ data_profile.judul }}', `{{ data_profile.deskripsi|escapejs }}`)" 
                                            class="btn btn-sm btn-light-primary">
                                        Preview
                                    </button>
                                </td>                                
                                <td class="text-end">
                                    <a href="#" class="btn btn-light btn-active-light-primary btn-flex btn-center btn-sm" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
                                        Actions 
                                        <i class="ki-outline ki-down fs-5 ms-1"></i>
                                    </a>
                                    <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4" data-kt-menu="true">
                                        <div class="menu-item px-3">
												<a data-alt="{% url 'admin:edit_master_profile' data_profile.profile_id %}" data-modal-title="Edit Profile" onclick="ModalTambah(this)"  class="menu-link px-3">
                                                    Edit</a>
											</div>
                                        <!--end::Menu item-->
                                        <div class="menu-item px-3">
                                            <form method="post" action="{% url 'admin:archive_master_profile' data_profile.profile_id %}" id="archive-form-{{ data_profile.profile_id }}">
                                                {% csrf_token %}
                                                <a href="#" class="menu-link px-3" onclick="confirmArchive('{{ data_profile.profile_id }}')">
                                                    Arsipkan
                                                </a>
                                            </form>
                                        </div>
                                        <!--end::Menu item-->
                                    </div>
                                    <!--end::Menu-->
                                </td>
                            </tr>
                            
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                    <!--end::Table-->
                </div>
                <!--end::Card body-->
                
                
                <!--end::Arsip View-->
            </div>
            
        </div>
        <!--end::Content-->
    </div>
    <!--end::Content wrapper-->
    
    <!--end::Footer-->
</div>

<div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pdfPreviewTitle">Preview Deskripsi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="pdfViewerContainer" style="height: 70vh; overflow-y: auto; border: 1px solid #eee; padding: 20px; background: #f9f9f9;">
                    <div id="pdfContent"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary" onclick="printPdfContent()">
                    <i class="ki-outline ki-printer fs-2"></i> Cetak
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block js %}
<script src="{% static 'admin/assets/js/custom/main-modul.js' %}"></script>
<script>
    /**
* Fungsi untuk menangani pengurutan khusus pada kolom "No" DataTables
* 
* Kita perlu menambahkan data untuk pengurutan yang sebenarnya karena
* nilai yang ditampilkan di kolom No (meta.row + 1) adalah nilai yang 
* sudah berubah berdasarkan pengurutan saat ini.
*/
$.fn.dataTable.ext.order['row-number'] = function (settings, col) {
return this.api().column(col, {order:'index'}).nodes().map(function (td, i) {
    // Kita memberikan indeks asli (awal) sebagai nilai untuk pengurutan
    return i + 1;
});
};

// Fungsi untuk inisialisasi DataTable
function initDataTableArsip() {
// Destroy DataTable jika sudah ada
if ($.fn.DataTable.isDataTable('#table_arsip_profile')) {
    $('#table_arsip_profile').DataTable().destroy();
}

// Inisialisasi ulang DataTable dengan konfigurasi untuk nomor urut
}

// Inisialisasi DataTable utama dengan konfigurasi nomor urut yang sama
function initMainDataTable() {
// Destroy jika sudah ada
if ($.fn.DataTable.isDataTable('#table_profile')) {
    $('#table_profile').DataTable().destroy();
}

// Inisialisasi DataTable
window.table = $('#table_profile').DataTable({
    columnDefs: [
        {
            targets: 0,
            orderable: true,  // Mengaktifkan pengurutan untuk kolom nomor
            searchable: false,
            className: 'text-center',
            render: function (data, type, full, meta) {
                if (type === 'display' || type === 'filter') {
                    return meta.row + 1;
                }
                // Untuk pengurutan, gunakan indeks asli
                return meta.row;
            },
            // Menggunakan pengurutan khusus
            orderDataType: 'row-number'
        }
    ],
    
    // Menerapkan pengurutan default pada kolom "No" secara ascending
    order: [[0, 'asc']]
});

// Setup search event listener
$('#search').off('keyup').on('keyup', function () {
    window.table.search(this.value).draw();
});
}

// Inisialisasi ketika dokumen siap
$(document).ready(function () {
// Inisialisasi DataTable utama
initMainDataTable();

// Fungsi untuk modal arsip
window.ModalArsip = function(e) {
    showModal(e, {size: 'large'}, 'arsip', function() {
        // Callback setelah modal dimuat
        setTimeout(function() {
            initDataTableArsip();
        }, 300);
    });
};

// Fungsi untuk modal tambah/edit
window.ModalTambah = function(e) {
    showModal(e, {size: 'large'});
};

window.ModalEdit = function(e) {
    showModal(e, {size: 'large'});
};
});
</script>

<script>

function showTable() {
    document.getElementById('table-view').classList.remove('d-none');
    document.getElementById('arsip-view').classList.add('d-none');
    document.getElementById('arsip-btn').classList.remove('d-none');
    document.getElementById('tambah-btn').classList.remove('d-none');
    document.getElementById('back-btn').classList.add('d-none');
}

function showArsip() {
    document.getElementById('table-view').classList.add('d-none');
    document.getElementById('arsip-view').classList.remove('d-none');
    document.getElementById('arsip-btn').classList.add('d-none');
    document.getElementById('tambah-btn').classList.add('d-none');
    document.getElementById('back-btn').classList.remove('d-none');
}

    
    function confirmArchive(profileId) {
        Swal.fire({
            title: 'Konfirmasi Arsip',
            text: 'Apakah Anda yakin ingin mengarsipkan data ini?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Arsipkan!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('archive-form-' + profileId).submit();
            }
        });
    }
    function confirmPulihkan(profileId) {
        Swal.fire({
            title: 'Konfirmasi Arsip',
            text: 'Apakah Anda yakin ingin memulihkan data ini?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Pulihkan!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('archive-form-' + profileId).submit();
            }
        });
    }

    function confirmHapus(profileId) {
        Swal.fire({
            title: 'Konfirmasi Hapus',
            text: 'Apakah Anda yakin ingin menghapus data ini?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Hapus!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('archive-form-' + profileId).submit();
            }
        });
    }
    
    function ModalTambah(e) {
    // Tutup modal lain yang aktif sebelum membuka yang baru
    $('.modal').modal('hide');
    showModal(e, {size: 'large'});
}

function ModalEdit(e) {
    $('.modal').modal('hide');
    showModal(e, {size: 'large'});
}
    function ModalArsip(e) {
        $('.modal').modal('hide');
        showModal(e, {size: 'extra_large'},'arsip');
    }


</script>

										<script>
											function showPdfPreview(title, content) {
												// Tutup modal lain jika ada
												const anyOpenModal = document.querySelector('.modal.show');
												if (anyOpenModal) {
													const modalInstance = bootstrap.Modal.getInstance(anyOpenModal);
													if (modalInstance) modalInstance.hide();
												}
										
												// Set title modal
												document.getElementById('pdfPreviewTitle').textContent = 'Preview: ' + title;
										
												// Atur isi deskripsi
												const pdfContent = document.getElementById('pdfContent');
												pdfContent.innerHTML = '';
										
												const pdfContainer = document.createElement('div');
												pdfContainer.style.fontFamily = 'Arial, sans-serif';
												pdfContainer.style.lineHeight = '1.6';
												pdfContainer.style.padding = '20px';
												pdfContainer.style.maxWidth = '800px';
												pdfContainer.style.margin = '0 auto';
												pdfContainer.style.background = 'white';
												pdfContainer.style.boxShadow = '0 0 10px rgba(0,0,0,0.1)';
												pdfContainer.innerHTML = content;
										
												pdfContent.appendChild(pdfContainer);
										
												// Tampilkan modal preview
												const previewModal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
												previewModal.show();
											}
										
											function printPdfContent() {
												const printContent = document.getElementById('pdfContent').innerHTML;
												const originalContent = document.body.innerHTML;
										
												document.body.innerHTML = printContent;
												window.print();
												document.body.innerHTML = originalContent;
										
												window.location.reload();
											}
										</script>
{% endblock %}