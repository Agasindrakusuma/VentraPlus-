{% load static %}
<link href="{% static 'admin/assets/plugins/custom/datatables/datatables.bundle.css' %}" rel="stylesheet" type="text/css" />
<div class="card">
    <!--begin::Card header-->
    <div class="card-header border-0 pt-6">
        <!--begin::Card title-->
        <div class="card-title">
            <div class="d-flex align-items-center position-relative my-1">
                <i class="ki-outline ki-magnifier fs-3 position-absolute ms-5"></i>
                <input type="text" 
                       class="form-control form-control-solid w-250px ps-13" 
                       placeholder="Search profile..." 
                       value="{{ search_query|default:'' }}" id="search-arsip"/>
            </div>
        </div>  
        <div class="card-toolbar">
            </div>
        
        </div>
    </div>

    <table id="table_arsip_profile"
        class="table table-striped table-row-bordered gy-5 gs-7 border rounded table-hover"
    class="table align-middle table-row-dashed fs-6 gy-5"
    >
    <thead>
        <tr class="text-start text-muted fw-bold fs-7 text-uppercase gs-0">
            <th class="min-w-100px">No</th>
            <th class="min-w-125px">Images</th>
            <th class="min-w-125px">Tipe</th>
            <th class="min-w-125px">Deskripsi</th>
            <th class="min-w-125px">Tanggal Arsip</th>
            <th class="text-end min-w-100px">Actions</th>
        </tr>
    </thead>
    <tbody class="text-gray-600 fw-semibold">
        {% for data_arsip in dt_arsip %}
        <tr>
            <td>{{ forloop.counter }}</td>
            
            <td>
                <div class="symbol symbol-70px symbol-circle">
                {% if data_arsip.images %}
                    <img src="{{ data_arsip.images.url }}" alt="images" class="rounded">
                {% else %}
                <div class="symbol-label bg-light-primary text-primary fs-3 fw-bold">
                    <img src="{% static 'admin/assets/media/svg/files/blank-image.svg' %}" width="100" alt="No Image">
                {% endif %}
            </td>
            <td>
                <span class="badge badge-light-primary">
                    {{ data_arsip.get_tipe_display }}
                </span>
            </td>
            <td>
                <button
                    onclick="showPdfPreview('{{ data_arsip.judul }}', `{{ data_arsip.deskripsi|escapejs }}`)"
                    class="btn btn-sm btn-light-primary"
                >
                    Preview
                </button>
            </td>
            <td>{{ data_arsip.archived_at|date:"d/m/Y H:i" }}</td>
            <td class="text-end">
                <a
                    href="#"
                    class="btn btn-light btn-active-light-primary btn-flex btn-center btn-sm"
                    data-kt-menu-trigger="click"
                    data-kt-menu-placement="bottom-end"
                >
                    Actions
                    <i class="ki-outline ki-down fs-5 ms-1"></i>
                </a>
                <div
                    class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4"
                    data-kt-menu="true"
                >
                    <div class="menu-item px-3">
                        <a
                            data-alt="{% url 'admin:edit_master_profile' data_arsip.profile_id %}"
                            data-modal-title="Edit arsip"
                            onclick="ModalEdit(this)"
                            class="menu-link px-3"
                        >
                            Edit
                        </a>
                    </div>
                    <div class="menu-item px-3">
                        <form
                            method="post"
                            action="{% url 'admin:restore_master_profile' data_arsip.profile_id %}"
                            id="archive-form-{{ data_profile.profile_id }}"
                        >
                            {% csrf_token %}
                            <a
                                href="#"
                                class="menu-link px-3"
                                onclick="confirmPulihkan('{{ data_profile.profile_id }}')"
                            >
                                pulihkan
                            </a>
                        </form>
                    </div>

                    <div class="menu-item px-3">
                        <form
                            method="get"
                            action="{% url 'admin:hapus_master_profile' data_arsip.profile_id %}"
                            id="archive-form-{{ data_arsip.profile_id }}"
                        >
                            {% csrf_token %}
                            <a
                                href="#"
                                class="menu-link px-3"
                                onclick="confirmHapus('{{ data_arsip.profile_id }}')"
                            >
                                hapus
                            </a>
                        </form>
                    </div>
                    </div>
                </td>
        </tr>
        
        {% endfor %}
    </tbody>
</table>
</div>

<div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-xl">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="pdfPreviewTitle">Preview Deskripsi</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
<div id="pdfViewerContainer" style="height: 70vh; overflow-y: auto; border: 1px solid #eee; padding: 20px; background: #f9f9f9;">
<div id="pdfContent"></div>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-light" data-bs-dismiss="modal">Tutup</button>
<button type="button" class="btn btn-primary" onclick="printPdfContent()">
<i class="ki-outline ki-printer fs-2"></i> Cetak
</button>
</div>
</div>
</div>
</div>

{% block js %}
<script src="{% static 'admin/assets/plugins/custom/datatables/datatables.bundle.js' %}"></script>
<script>
    function initDataTableArsip() {
        // Destroy DataTable jika sudah ada
        if ($.fn.DataTable.isDataTable('#table_arsip_profile')) {
            $('#table_arsip_profile').DataTable().destroy();
        }

        // Inisialisasi ulang DataTable
        window.table_arsip = new DataTable('#table_arsip_profile');

        // Setup search event listener
        $('#search-arsip').off('keyup').on('keyup', function () {
            window.table_arsip.search(this.value).draw();
        });

        console.log('DataTable diinisialisasi ulang');
    }

    // Inisialisasi saat dokumen siap
    $(document).ready(function () {
        initDataTableArsip();
    });

    // Jika menggunakan AJAX/SPA/tab/modal dynamic, pastikan panggil ini lagi setelah konten dimuat
    // Contoh: jika Anda reload bagian konten #table-view via AJAX
    function reloadArsipProfile() {
        $.get("{% url 'admin:arsip_master_profile' %}", function (html) {
            $('#table-view').html(html);
            initDataTableArsip(); // Panggil ulang setelah konten selesai dimuat
        });
    }

    // Anda bisa panggil reloadArsipKategori() dari tombol, tab, atau event lain sesuai kebutuhan
</script>
{% endblock %}




<script>
function showPdfPreview(title, content) {
// Tutup modal lain jika ada
const anyOpenModal = document.querySelector('.modal.show');
if (anyOpenModal) {
const modalInstance = bootstrap.Modal.getInstance(anyOpenModal);
if (modalInstance) modalInstance.hide();
}

// Set title modal
document.getElementById('pdfPreviewTitle').textContent = 'Preview: ' + title;

// Atur isi deskripsi
const pdfContent = document.getElementById('pdfContent');
pdfContent.innerHTML = '';

const pdfContainer = document.createElement('div');
pdfContainer.style.fontFamily = 'Arial, sans-serif';
pdfContainer.style.lineHeight = '1.6';
pdfContainer.style.padding = '20px';
pdfContainer.style.maxWidth = '800px';
pdfContainer.style.margin = '0 auto';
pdfContainer.style.background = 'white';
pdfContainer.style.boxShadow = '0 0 10px rgba(0,0,0,0.1)';
pdfContainer.innerHTML = content;

pdfContent.appendChild(pdfContainer);

// Tampilkan modal preview
const previewModal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
previewModal.show();
}

function printPdfContent() {
const printContent = document.getElementById('pdfContent').innerHTML;
const originalContent = document.body.innerHTML;

document.body.innerHTML = printContent;
window.print();
document.body.innerHTML = originalContent;

window.location.reload();
}
</script>
